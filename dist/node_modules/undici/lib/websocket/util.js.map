{"version":3,"file":"util.js","sources":["../../../../../node_modules/undici/lib/websocket/util.js"],"sourcesContent":["'use strict'\n\nconst { kReadyState, kController, kResponse, kBinaryType, kWebSocketURL } = require('./symbols')\nconst { states, opcodes } = require('./constants')\nconst { MessageEvent, ErrorEvent } = require('./events')\n\n/* globals Blob */\n\n/**\n * @param {import('./websocket').WebSocket} ws\n */\nfunction isEstablished (ws) {\n  // If the server's response is validated as provided for above, it is\n  // said that _The WebSocket Connection is Established_ and that the\n  // WebSocket Connection is in the OPEN state.\n  return ws[kReadyState] === states.OPEN\n}\n\n/**\n * @param {import('./websocket').WebSocket} ws\n */\nfunction isClosing (ws) {\n  // Upon either sending or receiving a Close control frame, it is said\n  // that _The WebSocket Closing Handshake is Started_ and that the\n  // WebSocket connection is in the CLOSING state.\n  return ws[kReadyState] === states.CLOSING\n}\n\n/**\n * @param {import('./websocket').WebSocket} ws\n */\nfunction isClosed (ws) {\n  return ws[kReadyState] === states.CLOSED\n}\n\n/**\n * @see https://dom.spec.whatwg.org/#concept-event-fire\n * @param {string} e\n * @param {EventTarget} target\n * @param {EventInit | undefined} eventInitDict\n */\nfunction fireEvent (e, target, eventConstructor = Event, eventInitDict) {\n  // 1. If eventConstructor is not given, then let eventConstructor be Event.\n\n  // 2. Let event be the result of creating an event given eventConstructor,\n  //    in the relevant realm of target.\n  // 3. Initialize event’s type attribute to e.\n  const event = new eventConstructor(e, eventInitDict) // eslint-disable-line new-cap\n\n  // 4. Initialize any other IDL attributes of event as described in the\n  //    invocation of this algorithm.\n\n  // 5. Return the result of dispatching event at target, with legacy target\n  //    override flag set if set.\n  target.dispatchEvent(event)\n}\n\n/**\n * @see https://websockets.spec.whatwg.org/#feedback-from-the-protocol\n * @param {import('./websocket').WebSocket} ws\n * @param {number} type Opcode\n * @param {Buffer} data application data\n */\nfunction websocketMessageReceived (ws, type, data) {\n  // 1. If ready state is not OPEN (1), then return.\n  if (ws[kReadyState] !== states.OPEN) {\n    return\n  }\n\n  // 2. Let dataForEvent be determined by switching on type and binary type:\n  let dataForEvent\n\n  if (type === opcodes.TEXT) {\n    // -> type indicates that the data is Text\n    //      a new DOMString containing data\n    try {\n      dataForEvent = new TextDecoder('utf-8', { fatal: true }).decode(data)\n    } catch {\n      failWebsocketConnection(ws, 'Received invalid UTF-8 in text frame.')\n      return\n    }\n  } else if (type === opcodes.BINARY) {\n    if (ws[kBinaryType] === 'blob') {\n      // -> type indicates that the data is Binary and binary type is \"blob\"\n      //      a new Blob object, created in the relevant Realm of the WebSocket\n      //      object, that represents data as its raw data\n      dataForEvent = new Blob([data])\n    } else {\n      // -> type indicates that the data is Binary and binary type is \"arraybuffer\"\n      //      a new ArrayBuffer object, created in the relevant Realm of the\n      //      WebSocket object, whose contents are data\n      dataForEvent = new Uint8Array(data).buffer\n    }\n  }\n\n  // 3. Fire an event named message at the WebSocket object, using MessageEvent,\n  //    with the origin attribute initialized to the serialization of the WebSocket\n  //    object’s url's origin, and the data attribute initialized to dataForEvent.\n  fireEvent('message', ws, MessageEvent, {\n    origin: ws[kWebSocketURL].origin,\n    data: dataForEvent\n  })\n}\n\n/**\n * @see https://datatracker.ietf.org/doc/html/rfc6455\n * @see https://datatracker.ietf.org/doc/html/rfc2616\n * @see https://bugs.chromium.org/p/chromium/issues/detail?id=398407\n * @param {string} protocol\n */\nfunction isValidSubprotocol (protocol) {\n  // If present, this value indicates one\n  // or more comma-separated subprotocol the client wishes to speak,\n  // ordered by preference.  The elements that comprise this value\n  // MUST be non-empty strings with characters in the range U+0021 to\n  // U+007E not including separator characters as defined in\n  // [RFC2616] and MUST all be unique strings.\n  if (protocol.length === 0) {\n    return false\n  }\n\n  for (const char of protocol) {\n    const code = char.charCodeAt(0)\n\n    if (\n      code < 0x21 ||\n      code > 0x7E ||\n      char === '(' ||\n      char === ')' ||\n      char === '<' ||\n      char === '>' ||\n      char === '@' ||\n      char === ',' ||\n      char === ';' ||\n      char === ':' ||\n      char === '\\\\' ||\n      char === '\"' ||\n      char === '/' ||\n      char === '[' ||\n      char === ']' ||\n      char === '?' ||\n      char === '=' ||\n      char === '{' ||\n      char === '}' ||\n      code === 32 || // SP\n      code === 9 // HT\n    ) {\n      return false\n    }\n  }\n\n  return true\n}\n\n/**\n * @see https://datatracker.ietf.org/doc/html/rfc6455#section-7-4\n * @param {number} code\n */\nfunction isValidStatusCode (code) {\n  if (code >= 1000 && code < 1015) {\n    return (\n      code !== 1004 && // reserved\n      code !== 1005 && // \"MUST NOT be set as a status code\"\n      code !== 1006 // \"MUST NOT be set as a status code\"\n    )\n  }\n\n  return code >= 3000 && code <= 4999\n}\n\n/**\n * @param {import('./websocket').WebSocket} ws\n * @param {string|undefined} reason\n */\nfunction failWebsocketConnection (ws, reason) {\n  const { [kController]: controller, [kResponse]: response } = ws\n\n  controller.abort()\n\n  if (response?.socket && !response.socket.destroyed) {\n    response.socket.destroy()\n  }\n\n  if (reason) {\n    fireEvent('error', ws, ErrorEvent, {\n      error: new Error(reason)\n    })\n  }\n}\n\nmodule.exports = {\n  isEstablished,\n  isClosing,\n  isClosed,\n  fireEvent,\n  isValidSubprotocol,\n  isValidStatusCode,\n  failWebsocketConnection,\n  websocketMessageReceived\n}\n"],"names":["require$$0","require$$1","require$$2"],"mappings":"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","x_google_ignoreList":[0]}