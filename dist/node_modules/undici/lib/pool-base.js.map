{"version":3,"file":"pool-base.js","sources":["../../../../node_modules/undici/lib/pool-base.js"],"sourcesContent":["'use strict'\n\nconst DispatcherBase = require('./dispatcher-base')\nconst FixedQueue = require('./node/fixed-queue')\nconst { kConnected, kSize, kRunning, kPending, kQueued, kBusy, kFree, kUrl, kClose, kDestroy, kDispatch } = require('./core/symbols')\nconst PoolStats = require('./pool-stats')\n\nconst kClients = Symbol('clients')\nconst kNeedDrain = Symbol('needDrain')\nconst kQueue = Symbol('queue')\nconst kClosedResolve = Symbol('closed resolve')\nconst kOnDrain = Symbol('onDrain')\nconst kOnConnect = Symbol('onConnect')\nconst kOnDisconnect = Symbol('onDisconnect')\nconst kOnConnectionError = Symbol('onConnectionError')\nconst kGetDispatcher = Symbol('get dispatcher')\nconst kAddClient = Symbol('add client')\nconst kRemoveClient = Symbol('remove client')\nconst kStats = Symbol('stats')\n\nclass PoolBase extends DispatcherBase {\n  constructor () {\n    super()\n\n    this[kQueue] = new FixedQueue()\n    this[kClients] = []\n    this[kQueued] = 0\n\n    const pool = this\n\n    this[kOnDrain] = function onDrain (origin, targets) {\n      const queue = pool[kQueue]\n\n      let needDrain = false\n\n      while (!needDrain) {\n        const item = queue.shift()\n        if (!item) {\n          break\n        }\n        pool[kQueued]--\n        needDrain = !this.dispatch(item.opts, item.handler)\n      }\n\n      this[kNeedDrain] = needDrain\n\n      if (!this[kNeedDrain] && pool[kNeedDrain]) {\n        pool[kNeedDrain] = false\n        pool.emit('drain', origin, [pool, ...targets])\n      }\n\n      if (pool[kClosedResolve] && queue.isEmpty()) {\n        Promise\n          .all(pool[kClients].map(c => c.close()))\n          .then(pool[kClosedResolve])\n      }\n    }\n\n    this[kOnConnect] = (origin, targets) => {\n      pool.emit('connect', origin, [pool, ...targets])\n    }\n\n    this[kOnDisconnect] = (origin, targets, err) => {\n      pool.emit('disconnect', origin, [pool, ...targets], err)\n    }\n\n    this[kOnConnectionError] = (origin, targets, err) => {\n      pool.emit('connectionError', origin, [pool, ...targets], err)\n    }\n\n    this[kStats] = new PoolStats(this)\n  }\n\n  get [kBusy] () {\n    return this[kNeedDrain]\n  }\n\n  get [kConnected] () {\n    return this[kClients].filter(client => client[kConnected]).length\n  }\n\n  get [kFree] () {\n    return this[kClients].filter(client => client[kConnected] && !client[kNeedDrain]).length\n  }\n\n  get [kPending] () {\n    let ret = this[kQueued]\n    for (const { [kPending]: pending } of this[kClients]) {\n      ret += pending\n    }\n    return ret\n  }\n\n  get [kRunning] () {\n    let ret = 0\n    for (const { [kRunning]: running } of this[kClients]) {\n      ret += running\n    }\n    return ret\n  }\n\n  get [kSize] () {\n    let ret = this[kQueued]\n    for (const { [kSize]: size } of this[kClients]) {\n      ret += size\n    }\n    return ret\n  }\n\n  get stats () {\n    return this[kStats]\n  }\n\n  async [kClose] () {\n    if (this[kQueue].isEmpty()) {\n      return Promise.all(this[kClients].map(c => c.close()))\n    } else {\n      return new Promise((resolve) => {\n        this[kClosedResolve] = resolve\n      })\n    }\n  }\n\n  async [kDestroy] (err) {\n    while (true) {\n      const item = this[kQueue].shift()\n      if (!item) {\n        break\n      }\n      item.handler.onError(err)\n    }\n\n    return Promise.all(this[kClients].map(c => c.destroy(err)))\n  }\n\n  [kDispatch] (opts, handler) {\n    const dispatcher = this[kGetDispatcher]()\n\n    if (!dispatcher) {\n      this[kNeedDrain] = true\n      this[kQueue].push({ opts, handler })\n      this[kQueued]++\n    } else if (!dispatcher.dispatch(opts, handler)) {\n      dispatcher[kNeedDrain] = true\n      this[kNeedDrain] = !this[kGetDispatcher]()\n    }\n\n    return !this[kNeedDrain]\n  }\n\n  [kAddClient] (client) {\n    client\n      .on('drain', this[kOnDrain])\n      .on('connect', this[kOnConnect])\n      .on('disconnect', this[kOnDisconnect])\n      .on('connectionError', this[kOnConnectionError])\n\n    this[kClients].push(client)\n\n    if (this[kNeedDrain]) {\n      process.nextTick(() => {\n        if (this[kNeedDrain]) {\n          this[kOnDrain](client[kUrl], [this, client])\n        }\n      })\n    }\n\n    return this\n  }\n\n  [kRemoveClient] (client) {\n    client.close(() => {\n      const idx = this[kClients].indexOf(client)\n      if (idx !== -1) {\n        this[kClients].splice(idx, 1)\n      }\n    })\n\n    this[kNeedDrain] = this[kClients].some(dispatcher => (\n      !dispatcher[kNeedDrain] &&\n      dispatcher.closed !== true &&\n      dispatcher.destroyed !== true\n    ))\n  }\n}\n\nmodule.exports = {\n  PoolBase,\n  kClients,\n  kNeedDrain,\n  kAddClient,\n  kRemoveClient,\n  kGetDispatcher\n}\n"],"names":["require$$0","require$$1","require$$2","require$$3"],"mappings":"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","x_google_ignoreList":[0]}